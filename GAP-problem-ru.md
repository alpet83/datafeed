

Реальной головной болью при разработке загрузчиков данных стали пробелы в истории. Для некоторых бирж их очень много, скажем у Bitfinex в 2020-2021 может отсутствовать порой до половины минутных свечей. Поскольку изначальной задачей загрузчика была регенерация истории в локальной БД пользователя, несоответствие между объемами дневных и минутных свечей вызывало проблемы постоянных повторных запросов. В итоге даже пришлось реализовать кэширование запросов, сначала в память, а потом и на диск.

На сегодня изрядная часть логики скриптов посвящена отработке проблемных участков данных: минутные свечи теперь могут восстанавливаться из тиков, равно как производится коррекция объемов дневных свечей. Необходимость отрабатывать различные исключения, сильно усложнила отладку и оптимизацию, например на этапе инициализации изрядная часть времени тратится на валидацию блоков. Процессом исправления данных можно управлять через конфигурацию флагов в таблицах data_config: добавлении 4 разрешает ремонтировать загруженные блоки, добавление 8 разрешает очистку таблиц при детектировании избыточных записей. И все-же, несмотря на относительно работающие костыли, верным подходом я считаю писать тикеты в биржи что раздают данные противоречащие друг другу, с указанием чего не хватает в заданном временном интервале.